<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EyeSpecialist.ai - Advanced Clinical Decision Support</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #FAFAFA;
            min-height: 100vh;
        }

        .header {
            background-color: #0A3D62;
            color: white;
            padding: 1.5rem;
        }

        .header-content {
            max-width: 64rem;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
        }

        .header-subtitle {
            color: #bfdbfe;
            margin: 0;
            font-size: 0.875rem;
        }

        .assessment-header .header-title {
            font-size: 1.25rem;
        }

        .back-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #bfdbfe;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }

        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .main-content {
            max-width: 64rem;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .welcome-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #1C1C1C;
        }

        .welcome-description {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }

        .disclaimer {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 2rem;
            padding: 0.75rem;
            background-color: #fef3c7;
            border-radius: 0.25rem;
            border-left: 4px solid #f59e0b;
        }

        .condition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .condition-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .condition-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .condition-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .condition-title {
            font-weight: 600;
            font-size: 1.125rem;
            color: #1C1C1C;
            margin: 0;
        }

        .condition-description {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.75rem;
        }

        .condition-pathways {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .progress-container {
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }

        .progress-content {
            max-width: 64rem;
            margin: 0 auto;
            padding: 1rem;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .progress-bar {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 0.5rem;
        }

        .progress-fill {
            height: 0.5rem;
            border-radius: 9999px;
            transition: width 0.3s;
            background-color: #0A3D62;
        }

        .question-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #1C1C1C;
        }

        .question-subtitle {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 1rem;
            font-style: italic;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .option-button {
            width: 100%;
            padding: 1rem;
            text-align: left;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .option-button:hover {
            background-color: #eff6ff;
            border-color: #3b82f6;
        }

        .red-flags-box {
            background-color: #fef2f2;
            border: 1px solid #fca5a5;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .red-flags-title {
            font-weight: 600;
            color: #dc2626;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .red-flags-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .red-flag-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            color: #7f1d1d;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }

        .clinical-note {
            background-color: #eff6ff;
            border-left: 4px solid #0A3D62;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.875rem;
            color: #374151;
        }

        .hidden {
            display: none !important;
        }

        .icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .eye-icon {
            width: 32px;
            height: 32px;
        }

        .navigation-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: space-between;
        }

        .back-tab {
            background: white;
            border: 2px solid #0A3D62;
            color: #0A3D62;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-tab:hover {
            background-color: #0A3D62;
            color: white;
        }

        .back-tab:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .back-tab:disabled:hover {
            background: white;
            color: #0A3D62;
        }

        .recommendation-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .urgency-icon {
            padding: 0.5rem;
            border-radius: 50%;
            color: white;
        }

        .recommendation-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1C1C1C;
            margin: 0;
        }

        .recommendation-subtitle {
            color: #6b7280;
            margin: 0;
        }

        .reasoning-box {
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .reasoning-text {
            color: #374151;
            margin: 0;
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #1C1C1C;
        }

        .next-steps-box {
            background-color: #eff6ff;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #0A3D62;
        }

        .next-steps-text {
            color: #374151;
            margin: 0;
        }

        .section-margin {
            margin-bottom: 1.5rem;
        }

        .management-box {
            background-color: #f0fdf4;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #22c55e;
            margin-bottom: 1rem;
        }

        .management-title {
            font-weight: 600;
            color: #166534;
            margin-bottom: 0.5rem;
        }

        .management-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .management-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .secondary-button {
            flex: 1;
            background: white;
            border: 1px solid #d1d5db;
            color: #374151;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .secondary-button:hover {
            background-color: #f9fafb;
        }

        .primary-button {
            flex: 1;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: none;
            background-color: #0A3D62;
            transition: opacity 0.2s;
        }

        .primary-button:hover {
            opacity: 0.9;
        }

        .copy-button {
            flex: 1;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: none;
            background-color: #059669;
            transition: opacity 0.2s;
        }

        .copy-button:hover {
            opacity: 0.9;
        }

        .copy-success {
            background-color: #10b981 !important;
        }

        .severity-indicator {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .severity-score {
            font-weight: 600;
            color: #1C1C1C;
            margin-bottom: 0.25rem;
        }

        .severity-bar {
            width: 100%;
            height: 0.5rem;
            background-color: #e5e7eb;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .severity-fill {
            height: 100%;
            border-radius: 0.25rem;
            transition: width 0.5s ease;
            background: linear-gradient(to right, #22c55e, #FFC300, #dc3545);
        }
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div id="welcome-screen">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <div>
                        <h1 class="header-title">EyeSpecialist.ai</h1>
                        <p class="header-subtitle">Advanced clinical decision support for ophthalmology</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h2 class="welcome-title">Welcome. Select the presenting condition for clinical guidance.</h2>
                <p class="welcome-description">
                    This advanced tool provides evidence-based triage pathways based on comprehensive clinical algorithms. 
                    Each pathway includes detailed assessment criteria, management protocols, and safety-netting guidance.
                </p>
                <p class="disclaimer">
                    <strong>Clinical Notice:</strong> This tool provides guidance based on established clinical pathways. 
                    Always use your clinical judgement and consider patient-specific factors. Not a substitute for clinical assessment.
                </p>
            </div>

            <div class="condition-grid" id="condition-grid">
                <!-- Conditions will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Assessment Screen -->
    <div id="assessment-screen" class="hidden">
        <div class="header assessment-header">
            <div class="header-content">
                <div class="header-left">
                    <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <div>
                        <h1 class="header-title">EyeSpecialist.ai</h1>
                        <p class="header-subtitle" id="assessment-subtitle">Clinical Assessment</p>
                    </div>
                </div>
                <button class="back-button" onclick="startOver()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12,19 5,12 12,5"></polyline>
                    </svg>
                    Start Over
                </button>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-content">
                <div class="progress-text">
                    <span id="progress-text">Question 1 of 6</span>
                    <span id="progress-percent">17% Complete</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="red-flags-box hidden" id="red-flags-box">
                <h3 class="red-flags-title">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    Red Flags for This Condition
                </h3>
                <ul class="red-flags-list" id="red-flags-list">
                    <!-- Red flags will be populated dynamically -->
                </ul>
            </div>

            <div class="card">
                <h2 class="question-title" id="question-title">Loading question...</h2>
                <p class="question-subtitle hidden" id="question-subtitle"></p>

                <div id="question-options">
                    <!-- Question options will be populated by JavaScript -->
                </div>

                <div class="clinical-note hidden" id="clinical-note"></div>

                <div class="navigation-buttons" id="navigation-buttons">
                    <button class="back-tab" id="back-button" onclick="previousQuestion()" disabled>
                        <svg class="icon" viewBox="0 0 24 24">
                            <line x1="19" y1="12" x2="5" y2="12"></line>
                            <polyline points="12,19 5,12 12,5"></polyline>
                        </svg>
                        Back
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Screen -->
    <div id="results-screen" class="hidden">
        <div class="header assessment-header">
            <div class="header-content">
                <div class="header-left">
                    <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <div>
                        <h1 class="header-title">EyeSpecialist.ai</h1>
                        <p class="header-subtitle">Clinical Recommendation</p>
                    </div>
                </div>
                <button class="back-button" onclick="startOver()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12,19 5,12 12,5"></polyline>
                    </svg>
                    New Assessment
                </button>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <div class="recommendation-header">
                    <div class="urgency-icon" id="urgency-icon">
                        <!-- Icon will be populated by JavaScript -->
                    </div>
                    <div>
                        <h2 class="recommendation-title" id="recommendation-title">Referral</h2>
                        <p class="recommendation-subtitle" id="recommendation-subtitle">Condition</p>
                    </div>
                </div>

                <div class="reasoning-box">
                    <p class="reasoning-text" id="reasoning-text">Reasoning will appear here</p>
                </div>

                <div class="severity-indicator" id="severity-indicator">
                    <div class="severity-score" id="severity-score">Clinical Severity Score: 0</div>
                    <div class="severity-bar">
                        <div class="severity-fill" id="severity-fill"></div>
                    </div>
                </div>

                <div class="section-margin">
                    <h3 class="section-title">
                        <svg class="icon" viewBox="0 0 24 24">
                            <polyline points="9,18 15,12 9,6"></polyline>
                        </svg>
                        Referral Pathway
                    </h3>
                    <div class="next-steps-box">
                        <p class="next-steps-text" id="next-steps-text">Next steps will appear here</p>
                    </div>
                </div>

                <div class="section-margin">
                    <h3 class="section-title">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        Management Protocol
                    </h3>
                    <div class="management-box">
                        <h4 class="management-title">Immediate Management</h4>
                        <ul class="management-list" id="immediate-management">
                            <!-- Management steps will be populated by JavaScript -->
                        </ul>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="secondary-button" onclick="startOver()">New Assessment</button>
                    <button class="copy-button" id="copy-button" onclick="copyAssessmentResults()">Copy Assessment</button>
                    <button class="primary-button" onclick="window.print()">Generate Referral Letter</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application state
        let currentStep = 'welcome';
        let selectedCondition = null;
        let responses = {};
        let currentQuestionIndex = 0;
        let assessmentPath = [];
        let recommendation = null;
        let questionHistory = [];

        // Define the clinical schema with basic structure
        const clinicalSchema = {
            "Red Eye": {
                "description": "Comprehensive assessment for red eye presentations including infection, inflammation, and sight-threatening conditions",
                "pathways": ["Unilateral", "Bilateral", "Contact lens-related", "Post-operative"],
                "redFlags": [
                    "Recent cataract surgery or intravitreal injection (last 4 weeks)",
                    "Severe headache with vomiting",
                    "Pain waking patient at night",
                    "Reduced vision",
                    "Contact lens wearer with symptoms"
                ],
                "questions": [
                    {
                        "id": "laterality",
                        "text": "Is the red eye unilateral or bilateral?",
                        "options": ["Unilateral", "Bilateral"],
                        "clinicalNote": "Bilateral red eye often suggests allergic or infective causes"
                    },
                    {
                        "id": "pain_severity",
                        "text": "What is the severity of pain?",
                        "options": ["No pain", "Mild discomfort", "Severe pain with photophobia"],
                        "clinicalNote": "Severe pain suggests serious pathology"
                    },
                    {
                        "id": "vision_affected",
                        "text": "Is vision affected?",
                        "options": ["Normal vision", "Mild blur", "Significant vision loss"],
                        "clinicalNote": "Vision loss with red eye requires urgent assessment"
                    }
                ],
                "triageLogic": {
                    "emergency": [],
                    "urgent": [],
                    "routine": []
                }
            },
            "Flashes & Floaters": {
                "description": "Assessment for posterior vitreous detachment and retinal pathology",
                "pathways": ["Acute onset", "Chronic symptoms", "High-risk features"],
                "redFlags": [
                    "Shower of floaters/cobwebs",
                    "Progressive visual field loss",
                    "Curtain/shadow in vision",
                    "Recent onset arc-like flashes"
                ],
                "questions": [
                    {
                        "id": "onset_timing",
                        "text": "When did symptoms begin?",
                        "options": ["Within 24 hours", "Within 1 week", "Within 1 month", "Over 1 month ago"],
                        "clinicalNote": "Acute onset requires urgent assessment"
                    },
                    {
                        "id": "visual_field",
                        "text": "Any visual field loss?",
                        "options": ["Yes - progressive", "Yes - stable", "No"],
                        "clinicalNote": "Progressive field loss indicates retinal detachment"
                    }
                ],
                "triageLogic": {
                    "emergency": [],
                    "urgent": [],
                    "routine": []
                }
            },
            "Sudden Vision Loss": {
                "description": "Rapid assessment for acute vision loss - time-critical pathology",
                "pathways": ["Vascular", "Inflammatory", "Retinal", "Neurological"],
                "redFlags": [
                    "Complete vision loss",
                    "Giant cell arteritis symptoms",
                    "RAPD present",
                    "Cherry red spot"
                ],
                "questions": [
                    {
                        "id": "laterality",
                        "text": "Which eye(s) affected?",
                        "options": ["One eye (monocular)", "Both eyes (binocular)", "Unsure"],
                        "clinicalNote": "Monocular suggests ocular pathology"
                    },
                    {
                        "id": "onset_pattern",
                        "text": "Speed of vision loss?",
                        "options": ["Sudden (seconds)", "Rapid (minutes)", "Gradual (hours)", "Progressive (days)"],
                        "clinicalNote": "Instantaneous loss suggests vascular occlusion"
                    }
                ],
                "triageLogic": {
                    "emergency": [],
                    "urgent": [],
                    "routine": []
                }
            },
            "Raised IOP": {
                "description": "Management pathway for elevated intraocular pressure",
                "pathways": ["Acute symptomatic", "Chronic asymptomatic", "Steroid-induced"],
                "redFlags": [
                    "IOP >35 mmHg",
                    "Corneal edema",
                    "Fixed dilated pupil",
                    "Severe pain with nausea"
                ],
                "questions": [
                    {
                        "id": "iop_level",
                        "text": "What is the IOP measurement?",
                        "options": ["<21 mmHg", "21-30 mmHg", "31-40 mmHg", ">40 mmHg"],
                        "clinicalNote": "IOP >30 with symptoms requires urgent management"
                    },
                    {
                        "id": "symptoms",
                        "text": "Are there associated symptoms?",
                        "options": ["No symptoms", "Mild headache", "Severe pain + nausea"],
                        "clinicalNote": "Symptoms suggest acute angle closure"
                    }
                ],
                "triageLogic": {
                    "emergency": [],
                    "urgent": [],
                    "routine": []
                }
            },
            "Eyelid Problems": {
                "description": "Assessment for lid malposition, infection, and malignancy",
                "pathways": ["Infectious", "Mechanical", "Neoplastic", "Inflammatory"],
                "redFlags": [
                    "Orbital signs",
                    "Systemically unwell",
                    "Loss of eyelashes",
                    "Ulcerating lesion"
                ],
                "questions": [
                    {
                        "id": "problem_type",
                        "text": "What is the primary lid problem?",
                        "options": ["Swelling", "Malposition", "Lump/lesion", "Redness/inflammation"],
                        "clinicalNote": "Different pathways for infectious vs mechanical problems"
                    }
                ],
                "triageLogic": {
                    "emergency": [],
                    "urgent": [],
                    "routine": []
                }
            },
            "Watery Eyes": {
                "description": "Evaluation of epiphora - distinguishing reflex from obstructive causes",
                "pathways": ["Reflex tearing", "Lacrimal obstruction", "Lid malposition"],
                "redFlags": [
                    "Associated with lid swelling",
                    "Bloody tears",
                    "Recurrent infections"
                ],
                "questions": [
                    {
                        "id": "laterality",
                        "text": "Which eye(s) affected?",
                        "options": ["One eye", "Both eyes equally", "Both but one worse"],
                        "clinicalNote": "Unilateral suggests obstruction"
                    }
                ],
                "triageLogic": {
                    "emergency": [],
                    "urgent": [],
                    "routine": []
                }
            },
            "Pediatric Eye Problems": {
                "description": "Age-appropriate assessment for children's eye conditions",
                "pathways": ["Infant (<1yr)", "Toddler (1-3yr)", "School age (4-10yr)"],
                "redFlags": [
                    "White pupil (leukocoria)",
                    "Cloudy cornea",
                    "Nystagmus",
                    "Not fixing/following by 3 months"
                ],
                "questions": [
                    {
                        "id": "age_group",
                        "text": "What is the child's age?",
                        "options": ["0-6 months", "6-12 months", "1-3 years", "3-8 years", ">8 years"],
                        "clinicalNote": "Age determines urgency and referral pathway"
                    }
                ],
                "triageLogic": {
                    "emergency": [],
                    "urgent": [],
                    "routine": []
                }
            },
            "Diplopia": {
                "description": "Double vision assessment - distinguishing neurological from mechanical causes",
                "pathways": ["Monocular", "Binocular", "Variable"],
                "redFlags": [
                    "Pupil involvement (CN III)",
                    "Multiple cranial nerves",
                    "Progressive symptoms",
                    "Age >50 with acute onset"
                ],
                "questions": [
                    {
                        "id": "type",
                        "text": "Is diplopia monocular or binocular?",
                        "options": ["Resolves with one eye covered", "Persists with one eye", "Variable"],
                        "clinicalNote": "Monocular diplopia is usually refractive"
                    }
                ],
                "triageLogic": {
                    "emergency": [],
                    "urgent": [],
                    "routine": []
                }
            },
            "Headaches with Visual Symptoms": {
                "description": "Differentiating primary headaches from sight/life-threatening causes",
                "pathways": ["Migraine", "Raised ICP", "Vascular", "Ocular"],
                "redFlags": [
                    "Papilledema",
                    "New headache pattern >50 years",
                    "Worse on waking/valsalva"
                ],
                "questions": [
                    {
                        "id": "visual_symptoms",
                        "text": "What visual symptoms occur?",
                        "options": ["Zigzag lines", "Transient vision loss", "Persistent blur", "Double vision"],
                        "clinicalNote": "Classic migraine has positive phenomena"
                    }
                ],
                "triageLogic": {
                    "emergency": [],
                    "urgent": [],
                    "routine": []
                }
            },
            "Corneal Problems": {
                "description": "Assessment of corneal pathology including trauma, infection, and dystrophies",
                "pathways": ["Traumatic", "Infectious", "Inflammatory", "Degenerative"],
                "redFlags": [
                    "Contact lens wearer with pain",
                    "Penetrating injury suspicion",
                    "Dendritic ulcer pattern"
                ],
                "questions": [
                    {
                        "id": "precipitating_event",
                        "text": "Was there a precipitating event?",
                        "options": ["Trauma/injury", "Foreign body", "Chemical exposure", "No specific event"],
                        "clinicalNote": "Chemical injuries need immediate irrigation"
                    }
                ],
                "triageLogic": {
                    "emergency": [],
                    "urgent": [],
                    "routine": []
                }
            }
        };

        // Display conditions
        function displayConditions() {
            const conditionGrid = document.getElementById('condition-grid');
            conditionGrid.innerHTML = '';
            
            Object.entries(clinicalSchema).forEach(([name, schema]) => {
                const card = document.createElement('button');
                card.className = 'condition-card';
                card.onclick = () => selectCondition(name);
                
                card.innerHTML = `
                    <div class="condition-header">
                        <h3 class="condition-title">${name}</h3>
                        <svg class="icon" viewBox="0 0 24 24" style="opacity: 0.5;">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                    <p class="condition-description">${schema.description}</p>
                    <p class="condition-pathways">Pathways: ${schema.pathways.join(', ')}</p>
                `;
                
                conditionGrid.appendChild(card);
            });
        }

        // Select condition
        function selectCondition(condition) {
            selectedCondition = condition;
            currentQuestionIndex = 0;
            responses = {};
            assessmentPath = [];
            questionHistory = [];
            
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('assessment-screen').classList.remove('hidden');
            document.getElementById('assessment-subtitle').textContent = `${condition} Assessment`;
            
            displayRedFlags();
            displayQuestion();
        }

        // Display red flags
        function displayRedFlags() {
            const redFlagsBox = document.getElementById('red-flags-box');
            const redFlagsList = document.getElementById('red-flags-list');
            const schema = clinicalSchema[selectedCondition];
            
            if (schema.redFlags && schema.redFlags.length > 0) {
                redFlagsBox.classList.remove('hidden');
                redFlagsList.innerHTML = '';
                
                schema.redFlags.forEach(flag => {
                    const li = document.createElement('li');
                    li.className = 'red-flag-item';
                    li.innerHTML = `
                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        ${flag}
                    `;
                    redFlagsList.appendChild(li);
                });
            } else {
                redFlagsBox.classList.add('hidden');
            }
        }

        // Display question
        function displayQuestion() {
            const schema = clinicalSchema[selectedCondition];
            const questions = schema.questions;
            
            if (currentQuestionIndex >= questions.length) {
                generateRecommendation();
                return;
            }
            
            const question = questions[currentQuestionIndex];
            
            // Update progress
            const progressText = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
            const progressPercent = Math.round((currentQuestionIndex / questions.length) * 100);
            
            document.getElementById('progress-text').textContent = progressText;
            document.getElementById('progress-percent').textContent = `${progressPercent}% Complete`;
            document.getElementById('progress-fill').style.width = `${progressPercent}%`;
            
            // Display question
            document.getElementById('question-title').textContent = question.text;
            
            // Show/hide subtitle
            const subtitleElement = document.getElementById('question-subtitle');
            if (question.subtitle) {
                subtitleElement.textContent = question.subtitle;
                subtitleElement.classList.remove('hidden');
            } else {
                subtitleElement.classList.add('hidden');
            }
            
            // Display options
            const optionsContainer = document.getElementById('question-options');
            optionsContainer.innerHTML = '';
            
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'options-container';
            
            question.options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = option;
                button.onclick = () => selectAnswer(option);
                optionsDiv.appendChild(button);
            });
            
            optionsContainer.appendChild(optionsDiv);
            
            // Display clinical note
            const clinicalNoteElement = document.getElementById('clinical-note');
            if (question.clinicalNote) {
                clinicalNoteElement.textContent = question.clinicalNote;
                clinicalNoteElement.classList.remove('hidden');
            } else {
                clinicalNoteElement.classList.add('hidden');
            }
            
            // Update navigation
            const backButton = document.getElementById('back-button');
            backButton.disabled = questionHistory.length === 0;
        }

        // Select answer
        function selectAnswer(answer) {
            const schema = clinicalSchema[selectedCondition];
            const questions = schema.questions;
            const question = questions[currentQuestionIndex];
            
            // Store response
            responses[question.id] = answer;
            assessmentPath.push({
                question: question.text,
                answer: answer
            });
            
            // Store current index in history before moving forward
            questionHistory.push(currentQuestionIndex);
            
            // Move to next question
            currentQuestionIndex++;
            displayQuestion();
        }

        // Generate recommendation (simplified for demo)
        function generateRecommendation() {
            // For demo purposes, generate a simple recommendation
            recommendation = {
                urgency: 'urgent',
                condition: `${selectedCondition} requiring assessment`,
                management: [
                    "Urgent ophthalmology assessment recommended",
                    "Document visual acuity",
                    "Safety-net advice provided"
                ],
                reasoning: "Based on clinical assessment findings",
                referralTimeframe: "Within 24-48 hours",
                severityScore: 7
            };
            
            displayResults();
        }

        // Display results
        function displayResults() {
            document.getElementById('assessment-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.remove('hidden');
            
            // Set urgency icon and color
            const urgencyIcon = document.getElementById('urgency-icon');
            const iconColors = {
                emergency: '#dc2626',
                urgent: '#f59e0b',
                routine: '#10b981'
            };
            
            urgencyIcon.style.backgroundColor = iconColors[recommendation.urgency] || '#f59e0b';
            urgencyIcon.innerHTML = `
                <svg class="icon" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
            `;
            
            // Set recommendation text
            document.getElementById('recommendation-title').textContent = 
                `${recommendation.urgency.charAt(0).toUpperCase() + recommendation.urgency.slice(1)} Referral`;
            document.getElementById('recommendation-subtitle').textContent = recommendation.condition;
            document.getElementById('reasoning-text').textContent = recommendation.reasoning;
            
            // Set severity score
            const severityScore = recommendation.severityScore || 0;
            const percentage = Math.min(severityScore * 10, 100);
            document.getElementById('severity-score').textContent = `Clinical Severity Score: ${percentage}%`;
            document.getElementById('severity-fill').style.width = `${percentage}%`;
            
            // Set next steps
            document.getElementById('next-steps-text').textContent = 
                `${recommendation.urgency.toUpperCase()} ophthalmology referral required. Timeframe: ${recommendation.referralTimeframe}`;
            
            // Set management steps
            const immediateManagementList = document.getElementById('immediate-management');
            immediateManagementList.innerHTML = '';
            
            recommendation.management.forEach(step => {
                const li = document.createElement('li');
                li.className = 'management-item';
                li.innerHTML = `
                    <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    ${step}
                `;
                immediateManagementList.appendChild(li);
            });
            
            window.scrollTo(0, 0);
        }

        // Go to previous question
        function previousQuestion() {
            if (questionHistory.length > 0) {
                currentQuestionIndex = questionHistory.pop();
                const questions = clinicalSchema[selectedCondition].questions;
                const questionId = questions[currentQuestionIndex].id;
                delete responses[questionId];
                
                displayQuestion();
            }
        }

        // Start over
        function startOver() {
            currentStep = 'welcome';
            selectedCondition = null;
            responses = {};
            currentQuestionIndex = 0;
            assessmentPath = [];
            recommendation = null;
            questionHistory = [];
            
            document.getElementById('welcome-screen').classList.remove('hidden');
            document.getElementById('assessment-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.add('hidden');
            
            window.scrollTo(0, 0);
        }

        // Copy assessment results
        function copyAssessmentResults() {
            let resultText = `EyeSpecialist.ai Assessment Results\n\n`;
            resultText += `Condition: ${selectedCondition}\n`;
            resultText += `Urgency: ${recommendation.urgency.toUpperCase()}\n`;
            resultText += `Diagnosis: ${recommendation.condition}\n`;
            resultText += `Severity Score: ${recommendation.severityScore || 'N/A'}\n\n`;
            resultText += `Clinical Reasoning:\n${recommendation.reasoning}\n\n`;
            resultText += `Management:\n`;
            recommendation.management.forEach(step => {
                resultText += `â€¢ ${step}\n`;
            });
            resultText += `\nReferral Timeframe: ${recommendation.referralTimeframe}\n`;
            
            navigator.clipboard.writeText(resultText).then(() => {
                const button = document.getElementById('copy-button');
                button.textContent = 'Copied!';
                button.classList.add('copy-success');
                
                setTimeout(() => {
                    button.textContent = 'Copy Assessment';
                    button.classList.remove('copy-success');
                }, 2000);
            });
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            displayConditions();
        });
    </script>
</body>
</html>
